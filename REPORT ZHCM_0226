REPORT ZHCM_0226.

TABLES: HRP1001.

SELECTION-SCREEN: BEGIN OF BLOCK BL1 WITH FRAME TITLE TEXT-001.
PARAMETER P_GSBER   TYPE PA0001-GSBER OBLIGATORY.
PARAMETER P_DATE    TYPE SY-DATUM OBLIGATORY.
PARAMETER P_PRIKAZ  TYPE I.
PARAMETER P_RUK     TYPE PA0001-PERNR MATCHCODE OBJECT PREM.
PARAMETER P_MASSN   TYPE I AS LISTBOX VISIBLE LENGTH 25 OBLIGATORY.
SELECTION-SCREEN: END OF BLOCK BL1.

DATA: NAME  TYPE VRM_ID,
      LIST  TYPE VRM_VALUES,
      VALUE LIKE LINE OF LIST.

TYPES: BEGIN OF TY_MAIN,
         ROW       TYPE I,
         PERNR     TYPE PA0298-PERNR,
         ENAME     TYPE EMNAM,
         PLANS_TXT TYPE HRLINE79,
         ORG1_TXT  TYPE HRLINE79,
         MASSN     TYPE PA0298-MASSN,
         MNTXT     TYPE T529T-MNTXT,
         ORDNU     TYPE PA0298-ORDNU,
         ORDDT     TYPE PA0298-ORDDT,
         BEGDA     TYPE BEGDA,
         ENDDA     TYPE ENDDA,
       END OF TY_MAIN.

TYPES: BEGIN OF TY_GSBER,
         PERNR TYPE PA0001-PERNR,
         GSBER TYPE PA0001-GSBER,
         PERSK TYPE PA0001-PERSK,
       END OF TY_GSBER.

DATA: IT_MAIN TYPE STANDARD TABLE OF TY_MAIN,
      IS_MAIN TYPE TY_MAIN.

DATA: IT_GSBER TYPE STANDARD TABLE OF TY_GSBER,
      IS_GSBER TYPE TY_GSBER.

DATA: FIELDCATALOG TYPE SLIS_T_FIELDCAT_ALV WITH HEADER LINE,
      GD_TAB_GROUP TYPE SLIS_T_SP_GROUP_ALV,
      DISVARIANT   LIKE DISVARIANT,
      GD_LAYOUT    TYPE SLIS_LAYOUT_ALV,
      GD_REPID     LIKE SY-REPID,
      GT_EVENTS    TYPE SLIS_T_EVENT.


DATA: IT_T529T    TYPE STANDARD TABLE OF T529T,
      IS_T529T    TYPE T529T,
      ZOBJID      TYPE HRP1001-OBJID,
      V_ENDDA     TYPE BEGDA,
      V_GSBER_TXT TYPE GTEXT,
      V_CITY      TYPE CITY,
      V_ORDNU     TYPE PA0298-ORDNU,
      V_ORDDT     TYPE STRING,
      MONTH       TYPE STRING,
      V_INITS     TYPE STRING,
      V_NACHN     TYPE STRING,
      V_RUK_FIO   TYPE STRING,
      V_PLANS_RUK TYPE STRING,
      V_ORG_RUK   TYPE CHAR79.

DATA: SFNAME LIKE WWWDATATAB-OBJID,
      IT_VAL TYPE STANDARD TABLE OF ZWWW_VALUES WITH HEADER LINE.

DATA: DYFIELDS LIKE DYNPREAD OCCURS 0 WITH HEADER LINE.

DATA: S_PARAMS LIKE ZZS_FM_0035_1,
      S_DATA   TYPE ZHCM_FM_0035.

S_PARAMS-ENAME_X = 'X'. S_PARAMS-PLANS_TXT_X = 'X'. S_PARAMS-ORG1_TXT_X = 'X'.

AT SELECTION-SCREEN OUTPUT.

  VALUE-KEY  = 1.
  VALUE-TEXT = 'Отпуск (T1, TD, T9, T7, TE, T6, TA)'.
  APPEND VALUE TO LIST.

  VALUE-KEY  = 2.
  VALUE-TEXT = 'Отзыв (T2, T3)'.
  APPEND VALUE TO LIST.

  CALL FUNCTION 'VRM_SET_VALUES'
    EXPORTING
      ID     = 'P_MASSN'
      VALUES = LIST.

END-OF-SELECTION.

AT SELECTION-SCREEN ON VALUE-REQUEST FOR P_GSBER.

  CLEAR: DYFIELDS[],
  DYFIELDS.

  CALL FUNCTION 'HELP_VALUES_GET'
    EXPORTING
      FIELDNAME    = 'GSBER'
      TABNAME      = 'TGSBT'
    IMPORTING
      SELECT_VALUE = P_GSBER.

  CASE P_GSBER.
    WHEN 01.
      ZOBJID = '50000807'.
    WHEN 11.
      ZOBJID = '50034791'.
    WHEN 12.
      ZOBJID = '50005419'.
    WHEN 13.
      ZOBJID = '50034789'.
    WHEN 14.
      ZOBJID = '50009548'.
    WHEN 15.
      ZOBJID = '50006276'.
    WHEN 16.
      ZOBJID = '50011037'.
    WHEN 17.
      ZOBJID = '50008145'.
    WHEN 18.
      ZOBJID = '50012006'.
    WHEN 19.
      ZOBJID = '50013483'.
    WHEN 20.
      ZOBJID = '50013882'.
    WHEN 22.
      ZOBJID = '50011682'.
    WHEN 23.
      ZOBJID = '50012691'.
    WHEN 24.
      ZOBJID = '50015056'.
    WHEN 25.
      ZOBJID = '50014911'.
    WHEN 26.
      ZOBJID = '50015050'.
    WHEN 29.
      ZOBJID = '50010031'.
    WHEN 31.
      ZOBJID = '50005799'.
    WHEN 32.
      ZOBJID = '50008906'.
    WHEN 33.
      ZOBJID = '50002294'.
    WHEN 34.
      ZOBJID = '50002294'.
    WHEN 35.
      ZOBJID = '50042580'.
    WHEN 36.
      ZOBJID = '50042727'.
    WHEN 37.
      ZOBJID = '50042782'.
  ENDCASE.

  SELECT SINGLE * FROM HRP1001
                    WHERE OBJID = ZOBJID
                    AND   OTYPE = 'S'
                    AND   PLVAR = '01'
                    AND   RSIGN = 'A'
                    AND   RELAT = '008'
                    AND   SCLAS = 'P'
                    AND   ENDDA >= SY-DATUM
                    AND   BEGDA <= SY-DATUM.

  DYFIELDS-FIELDVALUE = HRP1001-SOBID.
  DYFIELDS-FIELDNAME = 'P_RUK'.
  APPEND DYFIELDS.
  CALL FUNCTION 'DYNP_VALUES_UPDATE'
    EXPORTING
      DYNAME     = SY-CPROG
      DYNUMB     = SY-DYNNR
    TABLES
      DYNPFIELDS = DYFIELDS.

START-OF-SELECTION.

  IF P_MASSN = '1'.
    SELECT PERNR MASSN ORDNU ORDDT BEGDA FROM PA0298 INTO CORRESPONDING FIELDS OF TABLE IT_MAIN
      WHERE ORDDT = P_DATE AND ( MASSN = 'T1' OR MASSN = 'TD' OR MASSN = 'T9' OR MASSN = 'T7' OR MASSN = 'TE'
    OR MASSN = 'T6' OR MASSN = 'TA' ).
  ELSE.
    SELECT PERNR MASSN ORDNU ORDDT BEGDA FROM PA0298 INTO CORRESPONDING FIELDS OF TABLE IT_MAIN
    WHERE ORDDT = P_DATE AND ( MASSN = 'T2' OR MASSN = 'T3' ).
  ENDIF.

  SELECT * FROM PA0001 INTO CORRESPONDING FIELDS OF TABLE IT_GSBER FOR ALL ENTRIES IN IT_MAIN
  WHERE PERNR = IT_MAIN-PERNR AND ENDDA => P_DATE AND BEGDA <= P_DATE.
  LOOP AT IT_MAIN INTO IS_MAIN.
    READ TABLE IT_GSBER INTO IS_GSBER WITH KEY PERNR = IS_MAIN-PERNR.
    IF IS_GSBER-PERSK = '42' OR IS_GSBER-PERSK = '44'.
      IS_GSBER-GSBER = '01'.
    ENDIF.
    IF IS_GSBER-GSBER NE P_GSBER.
      DELETE IT_MAIN.
    ENDIF.
  ENDLOOP.

  SELECT * FROM T529T INTO CORRESPONDING FIELDS OF TABLE IT_T529T WHERE SPRSL = 'R' AND MASSN = 'T1' OR MASSN = 'TD' OR MASSN = 'T9' OR MASSN = 'T7' OR MASSN = 'TE'
  OR MASSN = 'T6' OR MASSN = 'TA' OR MASSN = 'T2' OR MASSN = 'T3'.

  LOOP AT IT_MAIN INTO IS_MAIN.

    CALL FUNCTION 'ZHCM_FM_0035N'
      EXPORTING
        PERNR    = IS_MAIN-PERNR
        S_PARAMS = S_PARAMS
      IMPORTING
        S_DATA   = S_DATA.

    IS_MAIN-ENAME = S_DATA-ENAME.
    IS_MAIN-PLANS_TXT = S_DATA-PLANS_TXT.
    IS_MAIN-ORG1_TXT = S_DATA-ORG1_TXT.

    LOOP AT IT_T529T INTO IS_T529T WHERE MASSN = IS_MAIN-MASSN.
      IS_MAIN-MNTXT = IS_T529T-MNTXT.
    ENDLOOP.

    IF IS_MAIN-MASSN NE 'T2' AND IS_MAIN-MASSN NE 'T3'.
      SELECT SINGLE ENDDA FROM PA2001 INTO V_ENDDA WHERE PERNR = IS_MAIN-PERNR AND BEGDA = IS_MAIN-BEGDA.
      IS_MAIN-ENDDA = V_ENDDA.
    ENDIF.

    V_ORDNU = IS_MAIN-ORDNU.
    MODIFY IT_MAIN FROM IS_MAIN.
    CLEAR IS_MAIN.
    CLEAR V_ENDDA.

  ENDLOOP.

  PERFORM BUILD_FIELDCATALOG.
  PERFORM BUILD_LAYOUT.
  PERFORM DISPLAY_ALV_REPORT.


FORM BUILD_FIELDCATALOG.

  FIELDCATALOG-FIELDNAME   = 'PERNR'.
  FIELDCATALOG-SELTEXT_M   = 'Табельный номер'.
  FIELDCATALOG-EMPHASIZE   = 'X'.
  FIELDCATALOG-COL_POS     = 1.
  APPEND FIELDCATALOG TO FIELDCATALOG.
  CLEAR  FIELDCATALOG.

  FIELDCATALOG-FIELDNAME   = 'ENAME'.
  FIELDCATALOG-SELTEXT_M   = 'Ф.И.О. работника'.
  FIELDCATALOG-EMPHASIZE   = 'X'.
  FIELDCATALOG-COL_POS     = 2.
  APPEND FIELDCATALOG TO FIELDCATALOG.
  CLEAR  FIELDCATALOG.

  FIELDCATALOG-FIELDNAME   = 'PLANS_TXT'.
  FIELDCATALOG-SELTEXT_M   = 'Должность'.
  FIELDCATALOG-EMPHASIZE   = 'X'.
  FIELDCATALOG-COL_POS     = 3.
  APPEND FIELDCATALOG TO FIELDCATALOG.
  CLEAR  FIELDCATALOG.

  FIELDCATALOG-FIELDNAME   = 'ORG1_TXT'.
  FIELDCATALOG-SELTEXT_M   = 'Подразделение'.
  FIELDCATALOG-EMPHASIZE   = 'X'.
  FIELDCATALOG-COL_POS     = 4.
  APPEND FIELDCATALOG TO FIELDCATALOG.
  CLEAR  FIELDCATALOG.

  FIELDCATALOG-FIELDNAME   = 'MASSN'.
  FIELDCATALOG-SELTEXT_M   = 'Вид мероприятия'.
  FIELDCATALOG-EMPHASIZE   = 'X'.
  FIELDCATALOG-COL_POS     = 5.
  APPEND FIELDCATALOG TO FIELDCATALOG.
  CLEAR  FIELDCATALOG.

  FIELDCATALOG-FIELDNAME   = 'MNTXT'.
  FIELDCATALOG-SELTEXT_M   = 'Мероприятие'.
  FIELDCATALOG-EMPHASIZE   = 'X'.
  FIELDCATALOG-COL_POS     = 6.
  APPEND FIELDCATALOG TO FIELDCATALOG.
  CLEAR  FIELDCATALOG.

  FIELDCATALOG-FIELDNAME   = 'ORDNU'.
  FIELDCATALOG-SELTEXT_M   = 'Номер приказа'.
  FIELDCATALOG-EMPHASIZE   = 'X'.
  FIELDCATALOG-COL_POS     = 7.
  APPEND FIELDCATALOG TO FIELDCATALOG.
  CLEAR  FIELDCATALOG.

  FIELDCATALOG-FIELDNAME   = 'ORDDT'.
  FIELDCATALOG-SELTEXT_M   = 'Дата приказа'.
  FIELDCATALOG-EMPHASIZE   = 'X'.
  FIELDCATALOG-COL_POS     = 8.
  APPEND FIELDCATALOG TO FIELDCATALOG.
  CLEAR  FIELDCATALOG.

  FIELDCATALOG-FIELDNAME   = 'BEGDA'.
  FIELDCATALOG-SELTEXT_M   = 'Начало мероприятия'.
  FIELDCATALOG-EMPHASIZE   = 'X'.
  FIELDCATALOG-COL_POS     = 9.
  APPEND FIELDCATALOG TO FIELDCATALOG.
  CLEAR  FIELDCATALOG.

  FIELDCATALOG-FIELDNAME   = 'ENDDA'.
  FIELDCATALOG-SELTEXT_M   = 'Конец мероприятия'.
  FIELDCATALOG-EMPHASIZE   = 'X'.
  FIELDCATALOG-COL_POS     = 10.
  APPEND FIELDCATALOG TO FIELDCATALOG.
  CLEAR  FIELDCATALOG.

ENDFORM.                    " BUILD_FIELDCATALOG

FORM BUILD_LAYOUT.

  GD_LAYOUT-COLWIDTH_OPTIMIZE = 'X'.
  GD_LAYOUT-CELL_MERGE        = 'X'.

ENDFORM.                    " BUILD_LAYOUT

FORM DISPLAY_ALV_REPORT.

  GD_REPID = SY-REPID.

  CALL FUNCTION 'REUSE_ALV_GRID_DISPLAY'
    EXPORTING
      I_BUFFER_ACTIVE          = SPACE
      I_CALLBACK_PROGRAM       = GD_REPID
      I_CALLBACK_PF_STATUS_SET = 'WORD'
      I_CALLBACK_USER_COMMAND  = 'USER_COMMAND'
      IS_LAYOUT                = GD_LAYOUT
      IT_FIELDCAT              = FIELDCATALOG[]
      IT_EVENTS                = GT_EVENTS
      I_SAVE                   = 'X'
      IS_VARIANT               = DISVARIANT
    TABLES
      T_OUTTAB                 = IT_MAIN
    EXCEPTIONS
      PROGRAM_ERROR            = 1
      OTHERS                   = 2.

ENDFORM.                    " DISPLAY_ALV_REPORT

FORM WORD USING EXTAB.
  SET PF-STATUS 'WORD'.
ENDFORM. "WORD

FORM USER_COMMAND USING R_UCOMM     LIKE SY-UCOMM
                        RS_SELFIELD TYPE SLIS_SELFIELD.
  CASE R_UCOMM.
    WHEN 'PRIKAZ'.
      PERFORM CALL_FORMS.
      PERFORM PRINT_FORMS.
  ENDCASE.

ENDFORM.

FORM CALL_FORMS.

  DATA N TYPE I.

  SELECT SINGLE GTEXT FROM TGSBT INTO V_GSBER_TXT WHERE SPRAS = 'R' AND GSBER = P_GSBER.

  IT_VAL-VAR_NAME = ''.
  IT_VAL-VAR_NUM = 0.
  IT_VAL-FIND_TEXT = '[v_gsber_txt]'.
  IT_VAL-VALUE = V_GSBER_TXT.
  APPEND IT_VAL.

  SELECT SINGLE CITY FROM ZRECVISITES INTO V_CITY WHERE SPRSL = 'RU' AND GSBER = P_GSBER.

  IT_VAL-VAR_NAME = ''.
  IT_VAL-VAR_NUM = 0.
  IT_VAL-FIND_TEXT = '[v_city]'.
  IT_VAL-VALUE = V_CITY.
  APPEND IT_VAL.

  IT_VAL-VAR_NAME = ''.
  IT_VAL-VAR_NUM = 0.
  IT_VAL-FIND_TEXT = '[v_ordnu]'.
  IT_VAL-VALUE = V_ORDNU.
  APPEND IT_VAL.

  PERFORM MONTHS USING P_DATE.
  CONCATENATE '"' P_DATE+6(2) '"' INTO V_ORDDT.
  CONCATENATE V_ORDDT MONTH P_DATE+0(4) INTO V_ORDDT SEPARATED BY SPACE.

  IT_VAL-VAR_NAME = ''.
  IT_VAL-VAR_NUM = 0.
  IT_VAL-FIND_TEXT = '[v_orddt]'.
  IT_VAL-VALUE = V_ORDDT.
  APPEND IT_VAL.

  N = 1.

  LOOP AT IT_MAIN INTO IS_MAIN.
    IS_MAIN-ROW = N.
    MODIFY IT_MAIN FROM IS_MAIN.
    N = N + 1.
  ENDLOOP.

  IF P_RUK IS NOT INITIAL.

    CALL FUNCTION 'ZHCM_FM_0035'
      EXPORTING
        PERNR  = P_RUK
        DATE   = SY-DATUM
      IMPORTING
        PLANS  = V_PLANS_RUK
        ORGEH1 = V_ORG_RUK.

    REPLACE 'Администрация' WITH '' INTO V_ORG_RUK.
    REPLACE ' департамента' WITH '' INTO V_PLANS_RUK.
    REPLACE 'Департамент' WITH 'Департамента' INTO V_ORG_RUK.
    REPLACE 'Департ.' WITH 'Департамента ' INTO V_ORG_RUK.
    REPLACE 'Головной' WITH '' INTO V_ORG_RUK.
    REPLACE 'банк' WITH '' INTO V_ORG_RUK.
    REPLACE ' управления' WITH '' INTO V_PLANS_RUK.
    REPLACE ' отдела' WITH '' INTO V_PLANS_RUK.
    REPLACE 'Управление' WITH 'Управления' INTO V_ORG_RUK.
    REPLACE 'Упр.' WITH 'Управления' INTO V_ORG_RUK.
    REPLACE 'Отдел' WITH 'Отдела' INTO V_ORG_RUK.
    REPLACE 'Сектор' WITH ' Сектора' INTO V_ORG_RUK.
    REPLACE 'Руководство' WITH '' INTO V_ORG_RUK.

    IT_VAL-VAR_NAME = ''.
    IT_VAL-VAR_NUM = 0.
    IT_VAL-FIND_TEXT = '[v_plans_ruk]'.
    IT_VAL-VALUE = V_PLANS_RUK.
    APPEND IT_VAL.

    IT_VAL-VAR_NAME = ''.
    IT_VAL-VAR_NUM = 0.
    IT_VAL-FIND_TEXT = '[v_org_ruk]'.
    IT_VAL-VALUE = V_ORG_RUK.
    APPEND IT_VAL.

    SELECT SINGLE INITS NACHN FROM PA0002 INTO (V_INITS, V_NACHN) WHERE PERNR = P_RUK AND BEGDA <= SY-DATUM
    AND ENDDA >= SY-DATUM.
    CONCATENATE V_INITS V_NACHN INTO V_RUK_FIO SEPARATED BY SPACE.

    IT_VAL-VAR_NAME = ''.
    IT_VAL-VAR_NUM = 0.
    IT_VAL-FIND_TEXT = '[v_ruk_fio]'.
    IT_VAL-VALUE = V_RUK_FIO.
    APPEND IT_VAL.

  ELSE.

    IT_VAL-VAR_NAME = ''.
    IT_VAL-VAR_NUM = 0.
    IT_VAL-FIND_TEXT = '[v_plans_ruk]'.
    IT_VAL-VALUE = ''.
    APPEND IT_VAL.

    IT_VAL-VAR_NAME = ''.
    IT_VAL-VAR_NUM = 0.
    IT_VAL-FIND_TEXT = '[v_org_ruk]'.
    IT_VAL-VALUE = ''.
    APPEND IT_VAL.

    IT_VAL-VAR_NAME = ''.
    IT_VAL-VAR_NUM = 0.
    IT_VAL-FIND_TEXT = '[v_ruk_fio]'.
    IT_VAL-VALUE = ''.
    APPEND IT_VAL.

  ENDIF.

  CALL FUNCTION 'ZWWW_PREPARE_TABLE'
    EXPORTING
      LINE_NAME    = 'Строка'  "имя строки таблицы в шаблоне
      VAL_TYPE     = ''
    TABLES
      IT_ANY_TABLE = IT_MAIN  "внутренняя таблица с данными
      IT_VALUES    = IT_VAL. "таблица для 'ZWWW_OPENFORM'

ENDFORM.

FORM PRINT_FORMS.

  IF P_MASSN = '1'.
    SFNAME = 'ZFORM_ZHCM_0226_OTPUSKA'.
  ELSE.
    SFNAME = 'ZFORM_ZHCM_0226_OTZIVI'.
  ENDIF.

  CALL FUNCTION 'ZWWW_OPENFORM'
    EXPORTING
      FORM_NAME   = SFNAME
      "FILE_NAME   = TMP_DIR
      PROTECT     = ''
      PRINTDIALOG = ''
    TABLES
      IT_VALUES   = IT_VAL.

  REFRESH IT_VAL.
  CLEAR IT_VAL.

ENDFORM.

FORM MONTHS
     USING BEGDA LIKE SY-DATUM.

  CLEAR MONTH.

  IF BEGDA+4(2) = '01'.
    MONTH = 'января'.
  ELSEIF BEGDA+4(2) = '02'.
    MONTH = 'февраля'.
  ELSEIF BEGDA+4(2) = '03'.
    MONTH = 'марта'.
  ELSEIF BEGDA+4(2) = '04'.
    MONTH = 'апреля'.
  ELSEIF BEGDA+4(2) = '05'.
    MONTH = 'мая'.
  ELSEIF BEGDA+4(2) = '06'.
    MONTH = 'июня'.
  ELSEIF BEGDA+4(2) = '07'.
    MONTH = 'июля'.
  ELSEIF BEGDA+4(2) = '08'.
    MONTH = 'августа'.
  ELSEIF BEGDA+4(2) = '09'.
    MONTH = 'сентября'.
  ELSEIF BEGDA+4(2) = '10'.
    MONTH = 'октября'.
  ELSEIF BEGDA+4(2) = '11'.
    MONTH = 'ноября'.
  ELSEIF BEGDA+4(2) = '12'.
    MONTH = 'декабря'.
  ENDIF.

ENDFORM.
